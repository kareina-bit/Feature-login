<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shipway - Thanh to√°n ƒë∆°n h√†ng</title>
  <link rel="stylesheet" href="css/wallet.css">
</head>

<body>
<div class="page">

  <!-- ===== HEADER ===== -->
  <div class="header">
    <a href="index.html" class="back-home-btn" title="Quay v·ªÅ v√≠">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="19" y1="12" x2="5" y2="12"></line>
        <polyline points="12 19 5 12 12 5"></polyline>
      </svg>
    </a>
    <img src="../auth-service/img/logo.png" alt="Shipway" class="logo-img">
    <p class="desc">
      Thanh to√°n ƒë∆°n h√†ng<br>
      Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n
    </p>
  </div>

  <!-- ===== ORDER INFO ===== -->
  <div class="card">
    <h2>Th√¥ng tin ƒë∆°n h√†ng</h2>
    <div class="order-info">
      <div class="info-row">
        <span class="label">M√£ ƒë∆°n h√†ng:</span>
        <span class="value" id="orderId">Order #1</span>
      </div>
      <div class="info-row">
        <span class="label">Ph√≠ v·∫≠n chuy·ªÉn:</span>
        <span class="value" id="shippingFee">25,000 ‚Ç´</span>
      </div>
      <div class="info-row total">
        <span class="label">T·ªïng thanh to√°n:</span>
        <span class="value" id="totalAmount">25,000 ‚Ç´</span>
      </div>
    </div>
  </div>

  <!-- ===== PAYMENT METHOD ===== -->
  <div class="card">
    <h3>Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
    <div class="payment-methods">
      <div class="payment-method active" onclick="selectPaymentMethod('wallet')">
        <div class="method-icon">üí∞</div>
        <div class="method-info">
          <div class="method-name">S·ªë d∆∞ v√≠</div>
          <div class="method-balance" id="walletBalanceDisplay">0.000 ‚Ç´</div>
        </div>
        <div class="method-radio"></div>
      </div>
      
      <div class="payment-method" onclick="selectPaymentMethod('visa')">
        <div class="method-icon">üí≥</div>
        <div class="method-info">
          <div class="method-name">Visa</div>
          <div class="method-desc">Th·∫ª t√≠n d·ª•ng/Ghi n·ª£</div>
        </div>
        <div class="method-radio"></div>
      </div>
      
      <div class="payment-method" onclick="selectPaymentMethod('bankqr')">
        <div class="method-icon">üì±</div>
        <div class="method-info">
          <div class="method-name">QR Ng√¢n h√†ng</div>
          <div class="method-desc">Chuy·ªÉn kho·∫£n nhanh</div>
        </div>
        <div class="method-radio"></div>
      </div>
    </div>
  </div>

  <!-- ===== PAYMENT BUTTON ===== -->
  <div class="card">
    <button class="btn-primary" onclick="processPayment()">Thanh to√°n</button>
  </div>

  <!-- ===== PAYMENT STATUS ===== -->
  <div class="card hidden" id="paymentStatus">
    <h3>Tr·∫°ng th√°i thanh to√°n</h3>
    <div class="status-content">
      <div class="loading-spinner" id="loadingSpinner"></div>
      <p id="statusMessage">ƒêang x·ª≠ l√Ω thanh to√°n...</p>
    </div>
  </div>

</div>

<!-- Scripts -->
<script type="module">
  let selectedPaymentMethod = 'wallet';
  let orderAmount = 25000; // Default shipping fee

  // Get current wallet balance from localStorage
  function getWalletBalance() {
    const balance = localStorage.getItem('walletBalance') || '0';
    return parseFloat(balance);
  }

  // Update wallet balance
  function updateWalletBalance(newBalance) {
    localStorage.setItem('walletBalance', newBalance.toString());
  }

  // Get URL parameters
  function getUrlParams() {
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('orderId') || 'Order #1';
    const amount = parseFloat(urlParams.get('amount')) || 25000;
    
    document.getElementById('orderId').textContent = orderId;
    document.getElementById('shippingFee').textContent = amount.toLocaleString() + ' ‚Ç´';
    document.getElementById('totalAmount').textContent = amount.toLocaleString() + ' ‚Ç´';
    
    orderAmount = amount;
  }

  // Select payment method
  window.selectPaymentMethod = function(method) {
    // Remove active class from all methods
    document.querySelectorAll('.payment-method').forEach(el => {
      el.classList.remove('active');
    });
    
    // Add active class to selected method
    event.currentTarget.classList.add('active');
    
    selectedPaymentMethod = method;
  };
  document.addEventListener('DOMContentLoaded', () => {
    const order = JSON.parse(localStorage.getItem('currentOrder'));

    if (!order) {
      alert('Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng');
      window.location.href = 'index.html';
      return;
    }

    document.getElementById('orderId').innerText = order.orderId;
    document.getElementById('orderAmount').innerText =
      order.amount.toLocaleString('vi-VN') + ' ‚Ç´';
  });
  // Process payment
  window.processPayment = function() {
    const currentBalance = getWalletBalance();
    
    // Check wallet balance for wallet payment
    if (selectedPaymentMethod === 'wallet') {
      if (currentBalance < orderAmount) {
        alert('S·ªë d∆∞ t√†i kho·∫£n kh√¥ng ƒë·ªß, vui l√≤ng n·∫°p th√™m ti·ªÅn');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 1000);
        return;
      }
    }
 window.transactionHistory.addTransaction({
  title: `Thanh to√°n ƒë∆°n h√†ng ${order.orderId}`,
  amount: orderAmount,
  type: 'debit',
  date: new Date()
});

    // Show payment status
    document.getElementById('paymentStatus').classList.remove('hidden');
    document.getElementById('statusMessage').textContent = 'ƒêang x·ª≠ l√Ω thanh to√°n...';
    
    // Simulate 5-second payment processing
    setTimeout(() => {
      let successMessage = '';
      
      if (selectedPaymentMethod === 'wallet') {
        // Deduct amount from wallet
        const newBalance = currentBalance - orderAmount;
        updateWalletBalance(newBalance);
        successMessage = `Thanh to√°n th√†nh c√¥ng! ${orderAmount.toLocaleString()} ‚Ç´ ƒë√£ ƒë∆∞·ª£c tr·ª´ t·ª´ v√≠.`;
      } else if (selectedPaymentMethod === 'visa') {
        successMessage = `Thanh to√°n th√†nh c√¥ng qua Visa! ${orderAmount.toLocaleString()} ‚Ç´`;
      } else if (selectedPaymentMethod === 'bankqr') {
        successMessage = `Thanh to√°n th√†nh c√¥ng qua QR Ng√¢n h√†ng! ${orderAmount.toLocaleString()} ‚Ç´`;
      }
      
      // Add transaction record
      const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
      transactions.unshift({
        id: Date.now(),
        type: 'payment',
        amount: -orderAmount,
        description: `Thanh to√°n ${document.getElementById('orderId').textContent}`,
        date: new Date().toISOString(),
        status: 'success',
        method: selectedPaymentMethod
      });
      localStorage.setItem('transactions', JSON.stringify(transactions));
      
      // Show success message
      document.getElementById('loadingSpinner').style.display = 'none';
      document.getElementById('statusMessage').textContent = successMessage;
      
      // Redirect to order tracking or order detail page after 2 seconds
      setTimeout(() => {
        // For now, redirect back to wallet overview
        // In real app, this would redirect to order tracking
        window.location.href = 'index.html';
      }, 2000);
      
    }, 5000); // 5 seconds simulation
  };

  // Initialize page
  document.addEventListener('DOMContentLoaded', () => {
    getUrlParams();
    
    // Update wallet balance display
    const balance = getWalletBalance();
    document.getElementById('walletBalanceDisplay').textContent = balance.toLocaleString() + ' ‚Ç´';
  });
</script>

<style>
  .order-info {
    margin: 20px 0;
  }

  .info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #f0f0f0;
  }

  .info-row:last-child {
    border-bottom: none;
  }

  .info-row.total {
    border-top: 2px solid #ddd;
    margin-top: 10px;
    padding-top: 15px;
    font-weight: bold;
    font-size: 18px;
  }

  .label {
    color: #666;
    font-weight: 500;
  }

  .value {
    font-weight: 600;
    color: #333;
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #ffc107;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 20px auto;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .status-content {
    text-align: center;
    padding: 20px 0;
  }

  .hidden {
    display: none;
  }

  .payment-methods {
    margin: 20px 0;
  }

  .payment-method {
    display: flex;
    align-items: center;
    padding: 15px;
    border: 2px solid #f0f0f0;
    border-radius: 8px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .payment-method:hover {
    border-color: #e0e0e0;
  }

  .payment-method.active {
    border-color: #ffc107;
    background-color: #fff9e6;
  }

  .method-icon {
    font-size: 24px;
    margin-right: 15px;
  }

  .method-info {
    flex: 1;
  }

  .method-name {
    font-weight: 600;
    margin-bottom: 2px;
  }

  .method-desc {
    font-size: 12px;
    color: #666;
  }

  .method-balance {
    font-size: 14px;
    color: #28a745;
    font-weight: 600;
  }

  .method-radio {
    width: 20px;
    height: 20px;
    border: 2px solid #ddd;
    border-radius: 50%;
    position: relative;
  }

  .payment-method.active .method-radio {
    border-color: #ffc107;
  }

  .payment-method.active .method-radio::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 10px;
    height: 10px;
    background-color: #ffc107;
    border-radius: 50%;
  }
</style>

</body>
</html>
