# ğŸ—„ï¸ DATABASE WORKFLOW - Shipway

## ğŸ“Š Database Overview

**Database:** MongoDB (NoSQL)  
**ODM:** Mongoose  
**Database Name:** `shipway_driver`  
**Collections:** 2 collections chÃ­nh

```
shipway_driver/
â”œâ”€â”€ users        (LÆ°u thÃ´ng tin ngÆ°á»i dÃ¹ng)
â””â”€â”€ otps         (LÆ°u mÃ£ OTP táº¡m thá»i)
```

---

## ğŸ“‹ Collection 1: USERS

### Schema Structure

```javascript
{
  _id: ObjectId,              // Auto-generated by MongoDB
  phoneNumber: String,        // "+84912345678" (E.164 format, UNIQUE)
  phoneNumberVerified: Boolean, // true/false
  password: String,           // Hashed vá»›i bcrypt (select: false)
  fullName: String,           // "Nguyá»…n VÄƒn A"
  email: String,              // "user@example.com" (optional, sparse index)
  avatar: String,             // URL to avatar image (optional)
  role: String,               // "driver" hoáº·c "admin"
  status: String,             // "active", "inactive", "suspended"
  lastLogin: Date,            // Timestamp cá»§a láº§n login cuá»‘i
  createdAt: Date,            // Tá»± Ä‘á»™ng táº¡o bá»Ÿi timestamps
  updatedAt: Date             // Tá»± Ä‘á»™ng cáº­p nháº­t bá»Ÿi timestamps
}
```

### Indexes

```javascript
// Unique index on phoneNumber
{ phoneNumber: 1 } UNIQUE

// Sparse index on email (cho phÃ©p multiple null)
{ email: 1 } SPARSE

// Compound index for queries
{ status: 1, role: 1 }
```

### Sample Document

```json
{
  "_id": "65a1b2c3d4e5f6g7h8i9j0k1",
  "phoneNumber": "+84912345678",
  "phoneNumberVerified": true,
  "password": "$2a$10$XYZ123...hashed...",  // KhÃ´ng return máº·c Ä‘á»‹nh
  "fullName": "Nguyá»…n VÄƒn A",
  "email": null,
  "avatar": null,
  "role": "driver",
  "status": "active",
  "lastLogin": "2025-12-30T10:30:00.000Z",
  "createdAt": "2025-12-25T08:00:00.000Z",
  "updatedAt": "2025-12-30T10:30:00.000Z"
}
```

---

## ğŸ“‹ Collection 2: OTPS

### Schema Structure

```javascript
{
  _id: ObjectId,              // Auto-generated
  phoneNumber: String,        // "+84912345678"
  code: String,               // "123456" (6 chá»¯ sá»‘)
  purpose: String,            // "register", "login", "reset_password"
  expiresAt: Date,            // Timestamp háº¿t háº¡n (now + 5 minutes)
  verified: Boolean,          // true/false
  attempts: Number,           // Sá»‘ láº§n thá»­ verify (max: 5)
  createdAt: Date             // Tá»± Ä‘á»™ng táº¡o
}
```

### Indexes

```javascript
// TTL Index - MongoDB tá»± Ä‘á»™ng xÃ³a documents Ä‘Ã£ háº¿t háº¡n
{ expiresAt: 1 } TTL (expireAfterSeconds: 0)

// Index for phoneNumber
{ phoneNumber: 1 }

// Compound index for efficient queries
{ phoneNumber: 1, purpose: 1, verified: 1 }
```

### Sample Document

```json
{
  "_id": "65a1b2c3d4e5f6g7h8i9j0k2",
  "phoneNumber": "+84912345678",
  "code": "123456",
  "purpose": "reset_password",
  "expiresAt": "2025-12-30T10:35:00.000Z",  // now + 5 minutes
  "verified": false,
  "attempts": 0,
  "createdAt": "2025-12-30T10:30:00.000Z"
}
```

**TTL Index:** MongoDB tá»± Ä‘á»™ng xÃ³a document sau khi `expiresAt` pass

---

## ğŸ”„ FLOW 1: ÄÄ‚NG KÃ USER Má»šI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client Request: POST /api/v1/auth/otp/request             â”‚
â”‚ {                                                          â”‚
â”‚   "phoneNumber": "0912345678",                            â”‚
â”‚   "purpose": "register"                                    â”‚
â”‚ }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend: Format phone number                               â”‚
â”‚ "0912345678" â†’ "+84912345678"                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE QUERY 1: Check if user exists                    â”‚
â”‚                                                            â”‚
â”‚ db.users.findOne({                                         â”‚
â”‚   phoneNumber: "+84912345678"                             â”‚
â”‚ })                                                         â”‚
â”‚                                                            â”‚
â”‚ Result: null (user chÆ°a tá»“n táº¡i - OK for register)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE QUERY 2: Check recent OTP                        â”‚
â”‚                                                            â”‚
â”‚ db.otps.findOne({                                          â”‚
â”‚   phoneNumber: "+84912345678",                            â”‚
â”‚   purpose: "register",                                     â”‚
â”‚   verified: false,                                         â”‚
â”‚   expiresAt: { $gt: new Date() }                          â”‚
â”‚ }).sort({ createdAt: -1 })                                â”‚
â”‚                                                            â”‚
â”‚ Result: null (chÆ°a cÃ³ OTP gáº§n Ä‘Ã¢y - OK to create new)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE INSERT 1: Create OTP                             â”‚
â”‚                                                            â”‚
â”‚ db.otps.insertOne({                                        â”‚
â”‚   phoneNumber: "+84912345678",                            â”‚
â”‚   code: "123456",                                          â”‚
â”‚   purpose: "register",                                     â”‚
â”‚   expiresAt: new Date(Date.now() + 5*60*1000),           â”‚
â”‚   verified: false,                                         â”‚
â”‚   attempts: 0,                                             â”‚
â”‚   createdAt: new Date()                                    â”‚
â”‚ })                                                         â”‚
â”‚                                                            â”‚
â”‚ Result: OTP document created                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
            Send SMS (or log OTP)
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client Request: POST /api/v1/auth/register                â”‚
â”‚ {                                                          â”‚
â”‚   "phoneNumber": "0912345678",                            â”‚
â”‚   "otpCode": "123456",                                     â”‚
â”‚   "password": "password123",                               â”‚
â”‚   "fullName": "Nguyá»…n VÄƒn A"                              â”‚
â”‚ }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE QUERY 3: Verify OTP                              â”‚
â”‚                                                            â”‚
â”‚ db.otps.findOne({                                          â”‚
â”‚   phoneNumber: "+84912345678",                            â”‚
â”‚   code: "123456",                                          â”‚
â”‚   purpose: "register",                                     â”‚
â”‚   verified: false,                                         â”‚
â”‚   expiresAt: { $gt: new Date() }                          â”‚
â”‚ }).sort({ createdAt: -1 })                                â”‚
â”‚                                                            â”‚
â”‚ Result: OTP document found â†’ Valid                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE UPDATE 1: Mark OTP as verified                   â”‚
â”‚                                                            â”‚
â”‚ db.otps.updateOne(                                         â”‚
â”‚   { _id: otpRecord._id },                                 â”‚
â”‚   { $set: { verified: true } }                            â”‚
â”‚ )                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE INSERT 2: Create User                            â”‚
â”‚                                                            â”‚
â”‚ db.users.insertOne({                                       â”‚
â”‚   phoneNumber: "+84912345678",                            â”‚
â”‚   phoneNumberVerified: true,                               â”‚
â”‚   password: "$2a$10$...hashed...",  // Auto-hashed       â”‚
â”‚   fullName: "Nguyá»…n VÄƒn A",                               â”‚
â”‚   role: "driver",                                          â”‚
â”‚   status: "active",                                        â”‚
â”‚   lastLogin: new Date(),                                   â”‚
â”‚   createdAt: new Date(),                                   â”‚
â”‚   updatedAt: new Date()                                    â”‚
â”‚ })                                                         â”‚
â”‚                                                            â”‚
â”‚ Result: New user created in database                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
              Return JWT Tokens
```

### Database State After Registration

**Collection: users**
```javascript
// New user added
{
  "_id": ObjectId("..."),
  "phoneNumber": "+84912345678",
  "phoneNumberVerified": true,
  "password": "$2a$10$...hashed...",
  "fullName": "Nguyá»…n VÄƒn A",
  "role": "driver",
  "status": "active",
  "lastLogin": ISODate("2025-12-30T10:30:00Z"),
  "createdAt": ISODate("2025-12-30T10:30:00Z"),
  "updatedAt": ISODate("2025-12-30T10:30:00Z")
}
```

**Collection: otps**
```javascript
// OTP marked as verified
{
  "_id": ObjectId("..."),
  "phoneNumber": "+84912345678",
  "code": "123456",
  "purpose": "register",
  "expiresAt": ISODate("2025-12-30T10:35:00Z"),
  "verified": true,  // â† Changed to true
  "attempts": 1,
  "createdAt": ISODate("2025-12-30T10:30:00Z")
}
// Note: Sáº½ tá»± Ä‘á»™ng xÃ³a sau khi expiresAt pass (TTL index)
```

---

## ğŸ”„ FLOW 2: ÄÄ‚NG NHáº¬P

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client Request: POST /api/v1/auth/login                   â”‚
â”‚ {                                                          â”‚
â”‚   "phoneNumber": "0912345678",                            â”‚
â”‚   "password": "password123"                                â”‚
â”‚ }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend: Format phone number                               â”‚
â”‚ "0912345678" â†’ "+84912345678"                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE QUERY 1: Find user with password field           â”‚
â”‚                                                            â”‚
â”‚ db.users.findOne({                                         â”‚
â”‚   phoneNumber: "+84912345678"                             â”‚
â”‚ }).select('+password')  // Include password field         â”‚
â”‚                                                            â”‚
â”‚ Result: User document vá»›i password (hashed)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend: Verify password                                   â”‚
â”‚ bcrypt.compare("password123", user.password)              â”‚
â”‚                                                            â”‚
â”‚ Result: true (password Ä‘Ãºng)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE UPDATE 1: Update lastLogin                       â”‚
â”‚                                                            â”‚
â”‚ db.users.updateOne(                                        â”‚
â”‚   { _id: user._id },                                      â”‚
â”‚   {                                                        â”‚
â”‚     $set: {                                               â”‚
â”‚       lastLogin: new Date(),                              â”‚
â”‚       updatedAt: new Date()                               â”‚
â”‚     }                                                      â”‚
â”‚   }                                                        â”‚
â”‚ )                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
              Return JWT Tokens
```

### Database State After Login

**Collection: users**
```javascript
// User document updated
{
  "_id": ObjectId("..."),
  "phoneNumber": "+84912345678",
  "lastLogin": ISODate("2025-12-30T11:00:00Z"), // â† Updated
  "updatedAt": ISODate("2025-12-30T11:00:00Z")  // â† Updated
  // ... other fields unchanged
}
```

---

## ğŸ”„ FLOW 3: RESET PASSWORD (QUÃŠN Máº¬T KHáº¨U)

### Step 1: Request OTP

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client: POST /api/v1/auth/otp/request                     â”‚
â”‚ { "phoneNumber": "0912345678", "purpose": "reset_password" }
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE QUERY 1: Check if user exists                    â”‚
â”‚                                                            â”‚
â”‚ db.users.findOne({                                         â”‚
â”‚   phoneNumber: "+84912345678"                             â”‚
â”‚ })                                                         â”‚
â”‚                                                            â”‚
â”‚ âœ… Result: User found â†’ Continue                          â”‚
â”‚ âŒ Result: null â†’ Return Error 404                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE INSERT 1: Create OTP for reset_password          â”‚
â”‚                                                            â”‚
â”‚ db.otps.insertOne({                                        â”‚
â”‚   phoneNumber: "+84912345678",                            â”‚
â”‚   code: "789012",                                          â”‚
â”‚   purpose: "reset_password",                               â”‚
â”‚   expiresAt: new Date(Date.now() + 5*60*1000),           â”‚
â”‚   verified: false,                                         â”‚
â”‚   attempts: 0                                              â”‚
â”‚ })                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Step 2: Reset Password

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client: POST /api/v1/auth/password/reset                  â”‚
â”‚ {                                                          â”‚
â”‚   "phoneNumber": "0912345678",                            â”‚
â”‚   "otpCode": "789012",                                     â”‚
â”‚   "newPassword": "newpassword123"                          â”‚
â”‚ }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE QUERY 1: Find user                               â”‚
â”‚                                                            â”‚
â”‚ db.users.findOne({                                         â”‚
â”‚   phoneNumber: "+84912345678"                             â”‚
â”‚ }).select('+password')                                     â”‚
â”‚                                                            â”‚
â”‚ Result: User found                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE QUERY 2: Verify OTP                              â”‚
â”‚                                                            â”‚
â”‚ db.otps.findOne({                                          â”‚
â”‚   phoneNumber: "+84912345678",                            â”‚
â”‚   code: "789012",                                          â”‚
â”‚   purpose: "reset_password",                               â”‚
â”‚   verified: false,                                         â”‚
â”‚   expiresAt: { $gt: new Date() }                          â”‚
â”‚ })                                                         â”‚
â”‚                                                            â”‚
â”‚ Result: OTP valid                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE UPDATE 1: Mark OTP as verified                   â”‚
â”‚                                                            â”‚
â”‚ db.otps.updateOne(                                         â”‚
â”‚   { _id: otpRecord._id },                                 â”‚
â”‚   { $set: { verified: true } }                            â”‚
â”‚ )                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend: Hash new password                                 â”‚
â”‚ bcrypt.hash("newpassword123", 10)                         â”‚
â”‚                                                            â”‚
â”‚ Result: "$2a$10$...new_hashed_password..."                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE UPDATE 2: Update user password                   â”‚
â”‚                                                            â”‚
â”‚ user.password = "$2a$10$...new_hashed_password..."        â”‚
â”‚ await user.save()  // Mongoose pre-save hook hashes again â”‚
â”‚                                                            â”‚
â”‚ db.users.updateOne(                                        â”‚
â”‚   { _id: user._id },                                      â”‚
â”‚   {                                                        â”‚
â”‚     $set: {                                               â”‚
â”‚       password: "$2a$10$...new_hashed...",               â”‚
â”‚       updatedAt: new Date()                               â”‚
â”‚     }                                                      â”‚
â”‚   }                                                        â”‚
â”‚ )                                                          â”‚
â”‚                                                            â”‚
â”‚ Result: Password updated successfully                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Database State After Reset Password

**Collection: users**
```javascript
// User password updated
{
  "_id": ObjectId("..."),
  "phoneNumber": "+84912345678",
  "password": "$2a$10$...NEW_HASHED_PASSWORD...", // â† Changed
  "updatedAt": ISODate("2025-12-30T11:30:00Z")   // â† Updated
  // ... other fields unchanged
}
```

**Collection: otps**
```javascript
// OTP verified
{
  "_id": ObjectId("..."),
  "phoneNumber": "+84912345678",
  "code": "789012",
  "purpose": "reset_password",
  "verified": true,  // â† Changed
  "attempts": 1,
  // Will auto-delete after expiresAt (TTL)
}
```

---

## ğŸ” DATABASE QUERIES REFERENCE

### Common Queries

#### 1. Find user by phone
```javascript
db.users.findOne({ 
  phoneNumber: "+84912345678" 
})
```

#### 2. Find user with password
```javascript
db.users.findOne({ 
  phoneNumber: "+84912345678" 
}).select('+password')
```

#### 3. Check if phone exists
```javascript
const exists = await db.users.exists({ 
  phoneNumber: "+84912345678" 
})
// Returns: { _id: ObjectId } or null
```

#### 4. Count users
```javascript
const count = await db.users.countDocuments({ 
  status: "active" 
})
```

#### 5. Find valid OTP
```javascript
db.otps.findOne({
  phoneNumber: "+84912345678",
  code: "123456",
  purpose: "register",
  verified: false,
  expiresAt: { $gt: new Date() }
}).sort({ createdAt: -1 })
```

#### 6. Delete expired OTPs manually
```javascript
db.otps.deleteMany({
  expiresAt: { $lt: new Date() }
})
// Note: TTL index lÃ m viá»‡c nÃ y tá»± Ä‘á»™ng
```

#### 7. Find recent OTPs for user
```javascript
db.otps.find({
  phoneNumber: "+84912345678"
}).sort({ createdAt: -1 }).limit(5)
```

#### 8. Update user status
```javascript
db.users.updateOne(
  { phoneNumber: "+84912345678" },
  { 
    $set: { 
      status: "suspended",
      updatedAt: new Date()
    }
  }
)
```

---

## ğŸ“Š Database Monitoring

### View Current Data

```javascript
// Connect to MongoDB
mongosh "mongodb://localhost:27017/shipway_driver"

// View all users
db.users.find().pretty()

// View all OTPs
db.otps.find().pretty()

// Count documents
db.users.countDocuments()
db.otps.countDocuments()

// View indexes
db.users.getIndexes()
db.otps.getIndexes()
```

### Useful Aggregations

```javascript
// Users by role
db.users.aggregate([
  { $group: { _id: "$role", count: { $sum: 1 } } }
])

// Users by status
db.users.aggregate([
  { $group: { _id: "$status", count: { $sum: 1 } } }
])

// OTPs by purpose
db.otps.aggregate([
  { $group: { _id: "$purpose", count: { $sum: 1 } } }
])

// Recent registrations
db.users.find()
  .sort({ createdAt: -1 })
  .limit(10)
```

---

## ğŸ” Security Features

### 1. Password Hashing
```javascript
// Pre-save hook tá»± Ä‘á»™ng hash password
UserSchema.pre('save', async function(next) {
  if (!this.isModified('password')) return next();
  this.password = await bcrypt.hash(this.password, 10);
  next();
});
```

### 2. Password Select False
```javascript
// Password khÃ´ng return trong queries thÆ°á»ng
password: {
  type: String,
  select: false  // Pháº£i explicitly select('+password')
}
```

### 3. TTL Index for OTPs
```javascript
// MongoDB tá»± Ä‘á»™ng xÃ³a expired OTPs
expiresAt: {
  type: Date,
  index: { expireAfterSeconds: 0 }
}
```

### 4. Unique Phone Number
```javascript
// KhÃ´ng cho phÃ©p duplicate phone
phoneNumber: {
  type: String,
  unique: true
}
```

---

## ğŸ“ˆ Performance Optimization

### Indexes Created
```javascript
// users collection
db.users.createIndex({ phoneNumber: 1 }, { unique: true })
db.users.createIndex({ email: 1 }, { sparse: true })
db.users.createIndex({ status: 1, role: 1 })

// otps collection
db.otps.createIndex({ phoneNumber: 1, purpose: 1, verified: 1 })
db.otps.createIndex({ expiresAt: 1 }, { expireAfterSeconds: 0 })
```

### Query Optimization
- âœ… Use indexed fields in queries
- âœ… Limit number of documents returned
- âœ… Use `.lean()` for read-only operations
- âœ… Project only needed fields with `.select()`

---

## ğŸ› ï¸ Database Maintenance

### Backup
```bash
# Backup entire database
mongodump --db shipway_driver --out ./backup

# Restore
mongorestore --db shipway_driver ./backup/shipway_driver
```

### Clean Up
```javascript
// Remove old verified OTPs manually
db.otps.deleteMany({ 
  verified: true,
  createdAt: { $lt: new Date(Date.now() - 24*60*60*1000) }
})

// Remove inactive users (if needed)
db.users.deleteMany({ 
  status: "inactive",
  lastLogin: { $lt: new Date(Date.now() - 180*24*60*60*1000) }
})
```

---

## ğŸ“ Summary

**Collections:** 2  
**Documents per collection:**
- `users`: Persistent (khÃ´ng tá»± xÃ³a)
- `otps`: Temporary (tá»± xÃ³a sau khi expires)

**Key Operations:**
1. **Register:** INSERT user + INSERT OTP
2. **Login:** FIND user + UPDATE lastLogin
3. **Reset Password:** FIND user + VERIFY OTP + UPDATE password

**Auto Cleanup:**
- OTPs tá»± Ä‘á»™ng xÃ³a sau 5 phÃºt (TTL index)
- KhÃ´ng cáº§n manual cleanup

**Security:**
- Passwords always hashed
- OTPs expire automatically
- Phone numbers unique

---

**Version:** 1.0.0  
**Date:** 30/12/2025  
**Database:** MongoDB + Mongoose

